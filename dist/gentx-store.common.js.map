{"version":3,"file":"gentx-store.common.js","sources":["../utils.js","../index.js"],"sourcesContent":["const NODE_ENV = process.env.NODE_ENV;\n\nexport function invariant(condition, message) {\n  if (condition) return;\n  throw new Error(message);\n}\n\nexport function log(message) {\n  if (NODE_ENV === 'production') return;\n  console.log(message);\n}","import {invariant, log} from './utils';\n\nexport default class GentStore {\n\n  // constructor\n  constructor(options={}) {\n    this._check(options);\n    \n    this._isGentStore = true;\n    this.debug = !!options.debug;\n    this.name = options.name || 'GentStore';\n    this._state = options.initialState || {};\n    this._transactions = options.transactions || {};\n    this._modules = options.modules || {};\n    this._snapshot = options.snapshot || function(data) {\n      return JSON.parse(JSON.stringify(data));\n    }\n    this._observers = [];\n  }\n\n  _check(options) {\n    let sotreName = this.name;\n\n    invariant(\n      typeof options === 'object',\n      `gentx-store error ~ <${sotreName}>'s options must be an object!`\n    );\n\n    let initialState = options.initialState;\n    invariant(\n      !initialState || typeof initialState === 'object',\n      `gentx-store error ~ <${sotreName}>'s options.initialState must be an object!`\n    );\n\n    let transactions = options.transactions;\n    invariant(\n      !transactions || typeof transactions === 'object',\n      `gentx-store error ~ <${sotreName}>'s options.transactions must be an object!`\n    );\n\n    let snapshot = options.snapshot;\n    invariant(\n      !snapshot || typeof snapshot === 'function',\n      `gentx-store error ~ <${sotreName}>'s options.snapshot must be an function!`\n    )\n\n    let modules = options.modules || {};\n    invariant(\n      modules && typeof modules === 'object',\n      `gentx-store error ~ <${sotreName}>'s options.modules is must be object!`\n    );\n\n    Object.keys(modules).forEach(key => {\n      let module = modules[key];\n      invariant(\n        typeof module === 'object' && module._isGentStore,\n        `gentx-store error ~ <${sotreName}>'s module <${key}> must be a store instance!`\n      );\n    });\n  }\n\n  // subscribe\n  subscribe(observer) {\n    let observers = this._observers;\n    if (typeof observer === 'function') {\n      observer = {next: observer};\n    }\n    observers.push({\n      observer\n    });\n    \n    return {\n      unsubscribe() {\n        let i = observers.indexOf(observer);\n        observers.splice(i, 1);\n      }\n    }\n  }\n\n  // get store's state\n  getState() {\n    let state = this._state;\n\n    Object.keys(this._modules).forEach(moduleName => {\n      state[moduleName] = this._modules[moduleName].getState();\n    });\n\n    return state;\n  }\n\n  /**\n   * Get child module\n   * @param {String} mName \n   */\n  getChildModule(mName) {\n    return this._modules[mName];\n  }\n\n  /**\n   * clone a node in state, internal use: `options.snapshot` or `JSON.parse(JSON.stringify(node))`\n   * let userList = store.copy('user.list');\n   */\n  copy(path) {\n    let arr = path ? path.split('.') : [];\n    let find = this.state;\n\n    while (typeof find === 'object' && arr.length) {\n      find = find[arr.shift()];\n    }\n      \n    // not found\n    if (arr.length) return null;\n\n    return this._snapshot(find);\n  }\n\n  /**\n   * [commit description]\n   * store.commit('main.user.add', {username: ''})\n   */\n  commit(tsName, payload, parent='') {\n    let arr = tsName.split('.', 2);\n    let location = parent ? parent + '.' + arr[0] : arr[0];\n    let storeName = this.name;\n\n    // log\n    if (this.debug && !parent) {\n      console.log(`gentx-store log ~ <${storeName}> commit <${tsName}>`, this._snapshot(payload));\n    }\n\n    // module\n    if (arr.length > 1) {\n      let moduleName = arr[0];\n      let module = this._modules[moduleName];\n\n      invariant(\n        module,\n        `gentx-store error ~ <${storeName}>'s module <${moduleName}> is not defined!`\n      );\n\n      module.commit(arr[1], payload, location);\n\n      // let observer know\n      this.notify();\n\n      return;\n    }\n\n    // mutation\n    invariant(\n      this._transactions[tsName],\n      `gentx-store error ~ <${storeName}>'s transaction or module <${tsName}> is not defined!`\n    )\n\n    let tsFunc = this._transactions[tsName].bind(this);\n    tsFunc(payload, this._state, this);\n\n    // let observer know\n    this.notify();\n  }\n\n  notify() {\n    let curState = this.getState();\n    let observers = this._observers;\n    observers.forEach(observer => {\n      observer.observer.next(curState);\n    });\n  }\n\n  // store is also a observer\n  next({name, data}) {\n    this.commit(name, data);\n  }\n\n  error(error) {\n    let storeName = this.name;\n    console.log(`gentx-store error ~ <${storeName}> receive unexpect error:`);\n    console.log(error);\n  }\n\n  complete() {\n    //\n  }\n}\n"],"names":["invariant","condition","message","Error","GentStore","options","_check","_isGentStore","debug","name","_state","initialState","_transactions","transactions","_modules","modules","_snapshot","snapshot","data","JSON","parse","stringify","_observers","sotreName","keys","forEach","module","key","observer","observers","next","push","i","indexOf","splice","state","moduleName","getState","mName","path","arr","split","find","length","shift","tsName","payload","parent","location","storeName","log","commit","notify","tsFunc","bind","curState","error"],"mappings":"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"}